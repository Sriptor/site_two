<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobius AI</title>
    <!-- Подключение Highlight.js для подсветки кода -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Подключение языков для подсветки -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js"></script>
    <!-- Иконки -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Темная тема */
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #00c6ff;
            --bg-primary: #0a0e1a;
            --bg-secondary: #0f1729;
            --bg-tertiary: #1a2332;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --message-bg: #1a2332;
            --input-bg: #1a2332;
            --border-color: #2a3441;
            --hover-bg: #262c36;
            --error-bg: #490202;
            --error-text: #f85149;
            --success-bg: #043d35;
            --success-text: #3dd68c;
            --ball-size: 300px;
            --code-bg: #23241f;
            --code-border: #3a3a3a;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] {
            /* Светлая тема */
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #0084ff;
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --message-bg: #f0f2f5;
            --input-bg: #f0f2f5;
            --border-color: #e0e0e0;
            --hover-bg: #e6e6e6;
            --error-bg: #ffebee;
            --error-text: #d32f2f;
            --success-bg: #e6f7ee;
            --success-text: #2e7d32;
            --code-bg: #f5f5f5;
            --code-border: #e0e0e0;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s, transform 0.3s, box-shadow 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
        }
        
        /* Анимированный фон */
        .bg-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-animation span {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(106, 17, 203, 0.1);
            animation: move 25s linear infinite;
            bottom: -150px;
        }
        
        .bg-animation span:nth-child(1) {
            left: 25%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
        }
        
        .bg-animation span:nth-child(2) {
            left: 10%;
            width: 20px;
            height: 20px;
            animation-delay: 2s;
            animation-duration: 12s;
        }
        
        .bg-animation span:nth-child(3) {
            left: 70%;
            width: 20px;
            height: 20px;
            animation-delay: 4s;
        }
        
        .bg-animation span:nth-child(4) {
            left: 40%;
            width: 60px;
            height: 60px;
            animation-delay: 0s;
            animation-duration: 18s;
        }
        
        .bg-animation span:nth-child(5) {
            left: 65%;
            width: 20px;
            height: 20px;
            animation-delay: 0s;
        }
        
        .bg-animation span:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3s;
        }
        
        .bg-animation span:nth-child(7) {
            left: 35%;
            width: 150px;
            height: 150px;
            animation-delay: 7s;
        }
        
        .bg-animation span:nth-child(8) {
            left: 50%;
            width: 25px;
            height: 25px;
            animation-delay: 15s;
            animation-duration: 45s;
        }
        
        .bg-animation span:nth-child(9) {
            left: 20%;
            width: 15px;
            height: 15px;
            animation-delay: 2s;
            animation-duration: 35s;
        }
        
        .bg-animation span:nth-child(10) {
            left: 85%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 11s;
        }
        
        @keyframes move {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        /* Шарик на фоне чата */
        .chat-container {
            width: 100%;
            max-width: 100%;
            height: 90vh;
            background: var(--bg-secondary);
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.7s ease-in-out;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .background-ball {
            position: absolute;
            width: var(--ball-size);
            height: var(--ball-size);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(106,17,203,0.3) 0%, rgba(37,117,252,0.1) 100%);
            filter: blur(40px);
            pointer-events: none;
            z-index: 1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-header {
            padding: 15px 20px;
            background: var(--bg-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            animation: slideDown 0.5s ease-out;
            position: relative;
            z-index: 2;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-info {
            display: flex;
            align-items: center;
        }
        
        .bot-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(106, 17, 203, 0.5);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 17, 203, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(106, 17, 203, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 17, 203, 0); }
        }
        
        .bot-info h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .bot-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3dd68c;
            animation: pulse 2s infinite;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s, color 0.3s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg) scale(1.1);
            background-color: var(--hover-bg);
            color: var(--primary);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: transparent;
            position: relative;
            z-index: 2;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.5;
            animation: slideIn 0.4s ease-out;
            word-wrap: break-word;
            box-shadow: var(--card-shadow);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 4px;
            animation: userSlideIn 0.4s ease-out;
        }
        
        @keyframes userSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .bot-message {
            align-self: flex-start;
            background: var(--message-bg);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
            animation: botSlideIn 0.4s ease-out;
        }
        
        @keyframes botSlideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Стили для кода в стиле Sublime Text */
        .code-block {
            margin: 10px 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--code-border);
            background-color: var(--code-bg);
            box-shadow: var(--card-shadow);
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--code-border);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .code-lang {
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .copy-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .copy-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        pre {
            margin: 0;
            padding: 12px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        
        code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .inline-code {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            height: 30px;
            padding: 0 16px;
            background: var(--message-bg);
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--card-shadow);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        .chat-input-container {
            padding: 15px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            border-top: 1px solid var(--border-color);
            animation: slideUp 0.5s ease-out;
            position: relative;
            z-index: 2;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-input {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .chat-input::placeholder {
            color: var(--text-secondary);
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        .send-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            margin-left: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        }
        
        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.4);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
        }
        
        .send-button:active {
            transform: scale(0.95);
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.8s ease-in-out;
        }
        
        .welcome-message h3 {
            font-size: 22px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textGlow 2s infinite alternate;
        }
        
        @keyframes textGlow {
            from { filter: drop-shadow(0 0 2px rgba(106, 17, 203, 0.5)); }
            to { filter: drop-shadow(0 0 10px rgba(37, 117, 252, 0.8)); }
        }
        
        .welcome-message p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .clear-history {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
            transition: opacity 0.2s, color 0.2s, background 0.2s;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .clear-history:hover {
            background: var(--hover-bg);
            color: var(--error-text);
        }
        
        .error-message {
            color: var(--error-text);
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            background: var(--error-bg);
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Стили для скроллбара */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--hover-bg);
        }
        
        /* Анимация появления элементов с задержкой */
        .stagger-animation > * {
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        
        .stagger-animation > *:nth-child(1) { animation-delay: 0.1s; }
        .stagger-animation > *:nth-child(2) { animation-delay: 0.2s; }
        .stagger-animation > *:nth-child(3) { animation-delay: 0.3s; }
        .stagger-animation > *:nth-child(4) { animation-delay: 0.4s; }
        .stagger-animation > *:nth-child(5) { animation-delay: 0.5s; }
        
        /* Кнопка для вставки кода */
        .code-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
        }
        
        .code-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        /* Анимация загрузки */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(106, 17, 203, 0.2);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loader-text {
            margin-top: 20px;
            color: var(--text-primary);
            font-size: 16px;
            animation: pulseText 2s infinite;
        }
        
        @keyframes pulseText {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Улучшенные кнопки */
        .action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .action-button:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
        }
        
        /* Сообщение о статусе */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        .status-success {
            background: var(--success-bg);
            color: var(--success-text);
        }
        
        /* Улучшенный индикатор печати */
        .typing-indicator {
            position: relative;
        }
        
        .typing-indicator::before {
            content: "";
            position: absolute;
            top: -8px;
            left: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--message-bg);
        }
        
        /* Анимация для кнопки отправки */
        .send-button i {
            transition: transform 0.3s;
        }
        
        .send-button:hover i {
            transform: translateX(2px);
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Анимация загрузки -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <div class="loader-text">Loading Mobius AI...</div>
    </div>
    
    <!-- Анимированный фон -->
    <div class="bg-animation">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <!-- Шарик на фоне чата -->
        <div class="background-ball" id="backgroundBall"></div>
        
        <div class="chat-header">
            <div class="bot-info">
                <div class="bot-avatar">MO</div>
                <div>
                    <h2>Mobius AI</h2>
                    <div class="bot-status">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                </div>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <button class="clear-history" id="clearHistory">
                <i class="fas fa-trash-alt"></i>
                Clear History
            </button>
            <div class="welcome-message">
                <h3>Hello! I'm Mobius</h3>
                <p>Your cool AI assistant. How can I help you today?</p>
            </div>
        </div>
        
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message here...">
            <button class="code-button" id="codeButton" title="Insert code">
                <i class="fas fa-code"></i>
            </button>
            <button class="send-button" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const themeToggle = document.getElementById('themeToggle');
            const clearHistoryBtn = document.getElementById('clearHistory');
            const chatContainer = document.getElementById('chatContainer');
            const backgroundBall = document.getElementById('backgroundBall');
            const codeButton = document.getElementById('codeButton');
            const loader = document.getElementById('loader');
            
            // API Token - замените на свой
            const CHUTES_API_TOKEN = "cpk_95a34985697c48e18b4d15afdb7433de.9d53560d744755e48885754ebab98286.JV7Ntv4MevW0zgieUO4QIBb1FL6s1vFm";
            const API_URL = "https://llm.chutes.ai/v1/chat/completions";
            
            // Системный промпт из Telegram-бота
            const SYSTEM_PROMPT = `You are Mobius, a cool and charismatic AI assistant created by teenager @Sceleon.
You're helpful, friendly, knowledgeable, and have a great sense of humor.
You speak in a casual, modern style but always remain respectful.
Only introduce yourself as Mobius when explicitly asked about your identity.
Keep your responses concise and engaging.
If you don't know something, admit it honestly.
You're tech-savvy and up-to-date with the latest trends.`;
            
            // Загрузка истории сообщений
            let messageHistory = JSON.parse(localStorage.getItem('mobiusChatHistory')) || [];
            
            // Загрузка темы
            const savedTheme = localStorage.getItem('mobiusTheme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Скрываем загрузчик через 1.5 секунды (имитация загрузки)
            setTimeout(() => {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
                
                // Отображение сохраненной истории
                if (messageHistory.length > 0) {
                    renderMessageHistory();
                }
            }, 1500);
            
            // Движение шарика от центра к курсору
            chatContainer.addEventListener('mousemove', (e) => {
                const rect = chatContainer.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                // Рассчитываем позицию курсора относительно чата
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Рассчитываем направление от центра к курсору
                const deltaX = mouseX - centerX;
                const deltaY = mouseY - centerY;
                
                // Ограничиваем движение шарика (не более 30% от центра к краю)
                const maxDistance = Math.min(rect.width, rect.height) * 0.3;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                let ballX, ballY;
                if (distance <= maxDistance) {
                    ballX = centerX + deltaX * 0.3; // Двигаем шарик только на 30% пути к курсору
                    ballY = centerY + deltaY * 0.3;
                } else {
                    // Если курсор далеко, ограничиваем движение шарика
                    const ratio = maxDistance / distance;
                    ballX = centerX + deltaX * ratio * 0.3;
                    ballY = centerY + deltaY * ratio * 0.3;
                }
                
                backgroundBall.style.transform = `translate(${ballX - rect.width/2}px, ${ballY - rect.height/2}px)`;
            });
            
            // Возвращаем шарик в центр, когда курсор покидает чат
            chatContainer.addEventListener('mouseleave', () => {
                backgroundBall.style.transform = `translate(-50%, -50%)`;
            });
            
            // Функция для обновления иконки темы
            function updateThemeIcon(theme) {
                const icon = themeToggle.querySelector('i');
                if (theme === 'dark') {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }
            
            // Переключение темы
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('mobiusTheme', newTheme);
                updateThemeIcon(newTheme);
                
                // Анимация кнопки
                themeToggle.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    themeToggle.style.transform = 'rotate(0)';
                }, 300);
            });
            
            // Очистка истории - удаляем все сообщения
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the chat history?')) {
                    messageHistory = [];
                    localStorage.removeItem('mobiusChatHistory');
                    
                    // Полностью очищаем чат
                    chatMessages.innerHTML = `
                        <button class="clear-history" id="clearHistory">
                            <i class="fas fa-trash-alt"></i>
                            Clear History
                        </button>
                        <div class="status-message status-success">
                            <i class="fas fa-check-circle"></i>
                            Chat history cleared successfully
                        </div>
                    `;
                    
                    // Повесим обработчик на новую кнопку
                    document.getElementById('clearHistory').addEventListener('click', arguments.callee);
                    
                    // Через 3 секунды убираем сообщение о статусе
                    setTimeout(() => {
                        const statusMessage = document.querySelector('.status-message');
                        if (statusMessage) {
                            statusMessage.remove();
                        }
                    }, 3000);
                }
            });
            
            // Функция для отображения истории сообщений
            function renderMessageHistory() {
                // Отображаем сообщения из истории
                messageHistory.forEach((msg, index) => {
                    if (msg.role !== 'system') {  // Не отображаем системные сообщения
                        setTimeout(() => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message');
                            messageElement.classList.add(msg.role === 'user' ? 'user-message' : 'bot-message');
                            
                            // Обрабатываем код в сообщении
                            processCodeInMessage(messageElement, msg.content);
                            
                            chatMessages.appendChild(messageElement);
                            
                            // Прокручиваем чат вниз
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, index * 100); // Задержка для каждого сообщения
                    }
                });
            }
            
            // Функция для обработки кода в сообщении
            function processCodeInMessage(element, content) {
                // Проверяем наличие блока кода ```
                const codeBlockRegex = /```([a-zA-Z0-9+-]*)?\n([\s\S]*?)```/g;
                let match;
                let lastIndex = 0;
                let resultHTML = '';
                
                while ((match = codeBlockRegex.exec(content)) !== null) {
                    // Добавляем текст до блока кода
                    resultHTML += escapeHtml(content.substring(lastIndex, match.index));
                    
                    // Извлекаем язык и код
                    const language = match[1] || '';
                    const code = match[2];
                    
                    // Создаем блок кода
                    const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                    resultHTML += `
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">${language || 'code'}</span>
                                <button class="copy-button" data-code-id="${codeId}">
                                    <i class="far fa-copy"></i>
                                    Copy
                                </button>
                            </div>
                            <pre><code id="${codeId}" class="${language}">${escapeHtml(code)}</code></pre>
                        </div>
                    `;
                    
                    lastIndex = match.index + match[0].length;
                }
                
                // Добавляем оставшийся текст после последнего блока кода
                resultHTML += escapeHtml(content.substring(lastIndex));
                
                // Обрабатываем inline-код `code`
                resultHTML = resultHTML.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');
                
                element.innerHTML = resultHTML;
                
                // Применяем подсветку синтаксиса ко всем блокам кода
                element.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // Добавляем обработчики для кнопок копирования
                element.querySelectorAll('.copy-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const codeId = this.getAttribute('data-code-id');
                        const codeElement = document.getElementById(codeId);
                        if (codeElement) {
                            // Копируем код в буфер обмена
                            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                                // Меняем текст кнопки на "Copied!"
                                const icon = this.querySelector('i');
                                const originalText = this.innerHTML;
                                this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                                
                                // Возвращаем исходный текст через 2 секунды
                                setTimeout(() => {
                                    this.innerHTML = originalText;
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                            });
                        }
                    });
                });
            }
            
            // Функция для экранирования HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Функция для добавления сообщения в чат и историю
            function addMessage(content, isUser = false) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(isUser ? 'user-message' : 'bot-message');
                
                // Добавляем сообщение в историю
                messageHistory.push({
                    role: isUser ? 'user' : 'assistant',
                    content: content
                });
                
                // Сохраняем историю в localStorage
                localStorage.setItem('mobiusChatHistory', JSON.stringify(messageHistory));
                
                if (isUser) {
                    // Обрабатываем код в сообщении пользователя
                    processCodeInMessage(messageElement, content);
                    chatMessages.appendChild(messageElement);
                } else {
                    // Для сообщений бота используем эффект печати
                    chatMessages.appendChild(messageElement);
                    typeMessage(messageElement, content);
                }
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Функция для эффекта печати сообщения по словам
            function typeMessage(element, text) {
                // Проверяем, содержит ли сообщение блоки кода
                const hasCodeBlocks = text.includes('```');
                
                if (hasCodeBlocks) {
                    // Если есть блоки кода, обрабатываем их и отображаем без эффекта печати
                    processCodeInMessage(element, text);
                } else {
                    // Если нет блоков кода, используем эффект печати по словам
                    const words = text.split(' ');
                    let currentText = '';
                    
                    // Начинаем с первого слова
                    if (words.length > 0) {
                        currentText = words[0];
                        element.textContent = currentText;
                        
                        // Добавляем остальные слова с задержкой
                        let index = 1;
                        const typingInterval = setInterval(() => {
                            if (index < words.length) {
                                currentText += ' ' + words[index];
                                element.textContent = currentText;
                                index++;
                            } else {
                                clearInterval(typingInterval);
                            }
                        }, 50); // Уменьшил задержку для более плавного эффекта
                    }
                }
            }
            
            // Функция для отображения индикатора печати
            function showTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.classList.add('typing-indicator');
                indicator.id = 'typingIndicator';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('typing-dot');
                    indicator.appendChild(dot);
                }
                
                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Функция для скрытия индикатора печати
            function hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            // Функция для отображения ошибки
            function showError(message) {
                const errorElement = document.createElement('div');
                errorElement.classList.add('error-message');
                errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                chatMessages.appendChild(errorElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Удаляем сообщение об ошибке через 5 секунд
                setTimeout(() => {
                    errorElement.remove();
                }, 5000);
            }
            
            // Функция для отображения успешного статуса
            function showSuccess(message) {
                const successElement = document.createElement('div');
                successElement.classList.add('status-message', 'status-success');
                successElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                chatMessages.appendChild(successElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Удаляем сообщение через 3 секунды
                setTimeout(() => {
                    successElement.remove();
                }, 3000);
            }
            
            // Функция для отправки сообщения в API Chutes
            async function sendMessageToAPI(message) {
                try {
                    // Подготавливаем сообщения для API
                    const apiMessages = [
                        {
                            role: "system",
                            content: SYSTEM_PROMPT
                        }
                    ];
                    
                    // Добавляем историю сообщений (кроме системных)
                    messageHistory.forEach(msg => {
                        if (msg.role !== 'system') {
                            apiMessages.push({
                                role: msg.role,
                                content: msg.content
                            });
                        }
                    });
                    
                    // Добавляем текущее сообщение пользователя
                    apiMessages.push({
                        role: "user",
                        content: message
                    });
                    
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${CHUTES_API_TOKEN}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "zai-org/GLM-4.5-Air",
                            messages: apiMessages,
                            stream: false,
                            max_tokens: 1024,
                            temperature: 0.7
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices.length > 0) {
                        return data.choices[0].message.content;
                    } else {
                        throw new Error("Invalid API response");
                    }
                } catch (error) {
                    console.error("Error calling API:", error);
                    throw error;
                }
            }
            
            // Функция для отправки сообщения
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (message === '') return;
                
                // Добавляем сообщение пользователя
                addMessage(message, true);
                
                // Очищаем поле ввода
                chatInput.value = '';
                
                // Показываем индикатор печати
                showTypingIndicator();
                
                // Анимация кнопки отправки
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                try {
                    // Отправляем запрос к API
                    const response = await sendMessageToAPI(message);
                    
                    // Скрываем индикатор печати
                    hideTypingIndicator();
                    
                    // Возвращаем обычную иконку
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    
                    // Добавляем ответ бота
                    addMessage(response);
                } catch (error) {
                    // Скрываем индикатор печати
                    hideTypingIndicator();
                    
                    // Возвращаем обычную иконку
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    
                    // Показываем ошибку
                    showError("Failed to get response from AI. Please try again later.");
                    console.error(error);
                }
            }
            
            // Обработчик нажатия кнопки отправки
            sendButton.addEventListener('click', sendMessage);
            
            // Обработчик нажатия Enter в поле ввода
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Обработчик кнопки для вставки кода
            codeButton.addEventListener('click', function() {
                const cursorPosition = chatInput.selectionStart;
                const textBefore = chatInput.value.substring(0, cursorPosition);
                const textAfter = chatInput.value.substring(cursorPosition);
                
                // Вставляем шаблон для кода
                chatInput.value = textBefore + "```\n\n```" + textAfter;
                
                // Устанавливаем курсор между ```
                chatInput.selectionStart = cursorPosition + 4;
                chatInput.selectionEnd = cursorPosition + 4;
                
                // Фокус на поле ввода
                chatInput.focus();
                
                // Анимация кнопки
                codeButton.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    codeButton.style.transform = 'scale(1)';
                }, 300);
            });
            
            // Фокус на поле ввода при загрузке
            chatInput.focus();
        });
    </script>
</body>
</html>
